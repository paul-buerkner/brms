<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>User-defined variables passed to Stan — stanvar • brms</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="User-defined variables passed to Stan — stanvar"><meta name="description" content="Prepare user-defined variables to be passed to one of Stan's
program blocks. This is primarily useful for defining more complex
priors, for refitting models without recompilation despite
changing priors, or for defining custom Stan functions."><meta property="og:description" content="Prepare user-defined variables to be passed to one of Stan's
program blocks. This is primarily useful for defining more complex
priors, for refitting models without recompilation despite
changing priors, or for defining custom Stan functions."></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">brms</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">2.22.12</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="../articles/brms_customfamilies.html">Define Custom Response Distributions with brms</a></li>
    <li><a class="dropdown-item" href="../articles/brms_distreg.html">Estimating Distributional Models with brms</a></li>
    <li><a class="dropdown-item" href="../articles/brms_families.html">Parameterization of Response Distributions in brms</a></li>
    <li><a class="dropdown-item" href="../articles/brms_missings.html">Handle Missing Values with brms</a></li>
    <li><a class="dropdown-item" href="../articles/brms_monotonic.html">Estimating Monotonic Effects with brms</a></li>
    <li><a class="dropdown-item" href="../articles/brms_multivariate.html">Estimating Multivariate Models with brms</a></li>
    <li><a class="dropdown-item" href="../articles/brms_nonlinear.html">Estimating Non-Linear Models with brms</a></li>
    <li><a class="dropdown-item" href="../articles/brms_phylogenetics.html">Estimating Phylogenetic Multilevel Models with brms</a></li>
    <li><a class="dropdown-item" href="../articles/brms_threading.html">Running brms models with within-chain parallelization</a></li>
  </ul></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/paul-buerkner/brms/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>User-defined variables passed to Stan</h1>
      <small class="dont-index">Source: <a href="https://github.com/paul-buerkner/brms/blob/HEAD/R/stanvars.R" class="external-link"><code>R/stanvars.R</code></a></small>
      <div class="d-none name"><code>stanvar.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>Prepare user-defined variables to be passed to one of Stan's
program blocks. This is primarily useful for defining more complex
priors, for refitting models without recompilation despite
changing priors, or for defining custom Stan functions.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">stanvar</span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  name <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  scode <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  block <span class="op">=</span> <span class="st">"data"</span>,</span>
<span>  position <span class="op">=</span> <span class="st">"start"</span>,</span>
<span>  pll_args <span class="op">=</span> <span class="cn">NULL</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-x">x<a class="anchor" aria-label="anchor" href="#arg-x"></a></dt>
<dd><p>An <span style="R">R</span> object containing data to be passed to Stan.
Only required if <code>block = 'data'</code> and ignored otherwise.</p></dd>


<dt id="arg-name">name<a class="anchor" aria-label="anchor" href="#arg-name"></a></dt>
<dd><p>Optional character string providing the desired variable
name of the object in <code>x</code>. If <code>NULL</code> (the default)
the variable name is directly inferred from <code>x</code>.</p></dd>


<dt id="arg-scode">scode<a class="anchor" aria-label="anchor" href="#arg-scode"></a></dt>
<dd><p>Line of Stan code to define the variable
in Stan language. If <code>block = 'data'</code>, the
Stan code is inferred based on the class of <code>x</code> by default.</p></dd>


<dt id="arg-block">block<a class="anchor" aria-label="anchor" href="#arg-block"></a></dt>
<dd><p>Name of one of Stan's program blocks in
which the variable should be defined. Can be <code>'data'</code>,
<code>'tdata'</code> (transformed data), <code>'parameters'</code>,
<code>'tparameters'</code> (transformed parameters), <code>'model'</code>,
<code>'likelihood'</code> (part of the model block where the likelihood is given),
<code>'genquant'</code> (generated quantities) or <code>'functions'</code>.</p></dd>


<dt id="arg-position">position<a class="anchor" aria-label="anchor" href="#arg-position"></a></dt>
<dd><p>Name of the position within the block where the
Stan code should be placed. Currently allowed are <code>'start'</code>
(the default) and <code>'end'</code> of the block.</p></dd>


<dt id="arg-pll-args">pll_args<a class="anchor" aria-label="anchor" href="#arg-pll-args"></a></dt>
<dd><p>Optional Stan code to be put into the header
of <code>partial_log_lik</code> functions. This ensures that the variables
specified in <code>scode</code> can be used in the likelihood even when
within-chain parallelization is activated via <code><a href="threading.html">threading</a></code>.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p>An object of class <code>stanvars</code>.</p>
    </div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>The <code>stanvar</code> function is not vectorized. Instead, multiple
<code>stanvars</code> objects can be added together via <code>+</code> (see Examples).</p>
<p>Special attention is necessary when using <code>stanvars</code> to inject
code into the <code>'likelihood'</code> block while having <code><a href="threading.html">threading</a></code>
activated. In this case, your custom Stan code may need adjustments to ensure
correct observation indexing. Please investigate the generated Stan code via
<code><a href="stancode.default.html">stancode</a></code> to see which adjustments are necessary in your case.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="va">bprior</span> <span class="op">&lt;-</span> <span class="fu"><a href="set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="va">mean_intercept</span>, <span class="fl">10</span><span class="op">)</span>, class <span class="op">=</span> <span class="st">"Intercept"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">stanvars</span> <span class="op">&lt;-</span> <span class="fu">stanvar</span><span class="op">(</span><span class="fl">5</span>, name <span class="op">=</span> <span class="st">"mean_intercept"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="stancode.html">stancode</a></span><span class="op">(</span><span class="va">count</span> <span class="op">~</span> <span class="va">Trt</span>, <span class="va">epilepsy</span>, prior <span class="op">=</span> <span class="va">bprior</span>,</span></span>
<span class="r-in"><span>         stanvars <span class="op">=</span> <span class="va">stanvars</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> // generated with brms 2.22.12</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> functions {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> data {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   int&lt;lower=1&gt; N;  // total number of observations</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   vector[N] Y;  // response variable</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   int&lt;lower=1&gt; K;  // number of population-level effects</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   matrix[N, K] X;  // population-level design matrix</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   int&lt;lower=1&gt; Kc;  // number of population-level effects after centering</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   int prior_only;  // should the likelihood be ignored?</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   real mean_intercept;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> transformed data {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   matrix[N, Kc] Xc;  // centered version of X without an intercept</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   vector[Kc] means_X;  // column means of X before centering</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   for (i in 2:K) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     means_X[i - 1] = mean(X[, i]);</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     Xc[, i - 1] = X[, i] - means_X[i - 1];</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> parameters {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   vector[Kc] b;  // regression coefficients</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   real Intercept;  // temporary intercept for centered predictors</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   real&lt;lower=0&gt; sigma;  // dispersion parameter</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> transformed parameters {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   // prior contributions to the log posterior</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   real lprior = 0;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   lprior += normal_lpdf(Intercept | mean_intercept, 10);</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   lprior += student_t_lpdf(sigma | 3, 0, 4.4)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     - 1 * student_t_lccdf(0 | 3, 0, 4.4);</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> model {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   // likelihood including constants</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   if (!prior_only) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     target += normal_id_glm_lpdf(Y | Xc, Intercept, b, sigma);</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   // priors including constants</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   target += lprior;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> generated quantities {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   // actual population-level intercept</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   real b_Intercept = Intercept - dot_product(means_X, b);</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> }</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># define a multi-normal prior with known covariance matrix</span></span></span>
<span class="r-in"><span><span class="va">bprior</span> <span class="op">&lt;-</span> <span class="fu"><a href="set_prior.html">prior</a></span><span class="op">(</span><span class="fu">multi_normal</span><span class="op">(</span><span class="va">M</span>, <span class="va">V</span><span class="op">)</span>, class <span class="op">=</span> <span class="st">"b"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">stanvars</span> <span class="op">&lt;-</span> <span class="fu">stanvar</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2</span><span class="op">)</span>, <span class="st">"M"</span>, scode <span class="op">=</span> <span class="st">"  vector[K] M;"</span><span class="op">)</span> <span class="op">+</span></span></span>
<span class="r-in"><span>  <span class="fu">stanvar</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span>, <span class="st">"V"</span>, scode <span class="op">=</span> <span class="st">"  matrix[K, K] V;"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="stancode.html">stancode</a></span><span class="op">(</span><span class="va">count</span> <span class="op">~</span> <span class="va">Trt</span> <span class="op">+</span> <span class="va">zBase</span>, <span class="va">epilepsy</span>,</span></span>
<span class="r-in"><span>         prior <span class="op">=</span> <span class="va">bprior</span>, stanvars <span class="op">=</span> <span class="va">stanvars</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> // generated with brms 2.22.12</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> functions {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> data {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   int&lt;lower=1&gt; N;  // total number of observations</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   vector[N] Y;  // response variable</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   int&lt;lower=1&gt; K;  // number of population-level effects</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   matrix[N, K] X;  // population-level design matrix</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   int&lt;lower=1&gt; Kc;  // number of population-level effects after centering</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   int prior_only;  // should the likelihood be ignored?</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     vector[K] M;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     matrix[K, K] V;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> transformed data {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   matrix[N, Kc] Xc;  // centered version of X without an intercept</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   vector[Kc] means_X;  // column means of X before centering</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   for (i in 2:K) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     means_X[i - 1] = mean(X[, i]);</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     Xc[, i - 1] = X[, i] - means_X[i - 1];</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> parameters {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   vector[Kc] b;  // regression coefficients</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   real Intercept;  // temporary intercept for centered predictors</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   real&lt;lower=0&gt; sigma;  // dispersion parameter</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> transformed parameters {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   // prior contributions to the log posterior</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   real lprior = 0;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   lprior += multi_normal_lpdf(b | M, V);</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   lprior += student_t_lpdf(Intercept | 3, 4, 4.4);</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   lprior += student_t_lpdf(sigma | 3, 0, 4.4)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     - 1 * student_t_lccdf(0 | 3, 0, 4.4);</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> model {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   // likelihood including constants</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   if (!prior_only) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     target += normal_id_glm_lpdf(Y | Xc, Intercept, b, sigma);</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   // priors including constants</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   target += lprior;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> generated quantities {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   // actual population-level intercept</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   real b_Intercept = Intercept - dot_product(means_X, b);</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> }</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># define a hierachical prior on the regression coefficients</span></span></span>
<span class="r-in"><span><span class="va">bprior</span> <span class="op">&lt;-</span> <span class="fu"><a href="set_prior.html">set_prior</a></span><span class="op">(</span><span class="st">"normal(0, tau)"</span>, class <span class="op">=</span> <span class="st">"b"</span><span class="op">)</span> <span class="op">+</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="set_prior.html">set_prior</a></span><span class="op">(</span><span class="st">"target += normal_lpdf(tau | 0, 10)"</span>, check <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">stanvars</span> <span class="op">&lt;-</span> <span class="fu">stanvar</span><span class="op">(</span>scode <span class="op">=</span> <span class="st">"real&lt;lower=0&gt; tau;"</span>,</span></span>
<span class="r-in"><span>                    block <span class="op">=</span> <span class="st">"parameters"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="stancode.html">stancode</a></span><span class="op">(</span><span class="va">count</span> <span class="op">~</span> <span class="va">Trt</span> <span class="op">+</span> <span class="va">zBase</span>, <span class="va">epilepsy</span>,</span></span>
<span class="r-in"><span>         prior <span class="op">=</span> <span class="va">bprior</span>, stanvars <span class="op">=</span> <span class="va">stanvars</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> // generated with brms 2.22.12</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> functions {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> data {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   int&lt;lower=1&gt; N;  // total number of observations</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   vector[N] Y;  // response variable</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   int&lt;lower=1&gt; K;  // number of population-level effects</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   matrix[N, K] X;  // population-level design matrix</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   int&lt;lower=1&gt; Kc;  // number of population-level effects after centering</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   int prior_only;  // should the likelihood be ignored?</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> transformed data {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   matrix[N, Kc] Xc;  // centered version of X without an intercept</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   vector[Kc] means_X;  // column means of X before centering</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   for (i in 2:K) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     means_X[i - 1] = mean(X[, i]);</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     Xc[, i - 1] = X[, i] - means_X[i - 1];</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> parameters {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   vector[Kc] b;  // regression coefficients</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   real Intercept;  // temporary intercept for centered predictors</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   real&lt;lower=0&gt; sigma;  // dispersion parameter</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   real&lt;lower=0&gt; tau;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> transformed parameters {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   // prior contributions to the log posterior</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   real lprior = 0;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   lprior += normal_lpdf(b | 0, tau);</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   lprior += student_t_lpdf(Intercept | 3, 4, 4.4);</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   lprior += student_t_lpdf(sigma | 3, 0, 4.4)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     - 1 * student_t_lccdf(0 | 3, 0, 4.4);</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> model {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   // likelihood including constants</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   if (!prior_only) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     target += normal_id_glm_lpdf(Y | Xc, Intercept, b, sigma);</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   // priors including constants</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   target += lprior;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   target += normal_lpdf(tau | 0, 10);</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> generated quantities {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   // actual population-level intercept</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   real b_Intercept = Intercept - dot_product(means_X, b);</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> }</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># ensure that 'tau' is passed to the likelihood of a threaded model</span></span></span>
<span class="r-in"><span><span class="co"># not necessary for this example but may be necessary in other cases</span></span></span>
<span class="r-in"><span><span class="va">stanvars</span> <span class="op">&lt;-</span> <span class="fu">stanvar</span><span class="op">(</span>scode <span class="op">=</span> <span class="st">"real&lt;lower=0&gt; tau;"</span>,</span></span>
<span class="r-in"><span>                    block <span class="op">=</span> <span class="st">"parameters"</span>, pll_args <span class="op">=</span> <span class="st">"real tau"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="stancode.html">stancode</a></span><span class="op">(</span><span class="va">count</span> <span class="op">~</span> <span class="va">Trt</span> <span class="op">+</span> <span class="va">zBase</span>, <span class="va">epilepsy</span>,</span></span>
<span class="r-in"><span>         stanvars <span class="op">=</span> <span class="va">stanvars</span>, threads <span class="op">=</span> <span class="fu"><a href="threading.html">threading</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> // generated with brms 2.22.12</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> functions {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   /* integer sequence of values</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>    * Args:</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>    *   start: starting integer</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>    *   end: ending integer</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>    * Returns:</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>    *   an integer sequence from start to end</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>    */</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   array[] int sequence(int start, int end) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     array[end - start + 1] int seq;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     for (n in 1:num_elements(seq)) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>       seq[n] = n + start - 1;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     return seq;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   // compute partial sums of the log-likelihood</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   real partial_log_lik_lpmf(array[] int seq, int start, int end, data vector Y, data matrix Xc, vector b, real Intercept, real sigma, real tau) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     real ptarget = 0;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     int N = end - start + 1;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     ptarget += normal_id_glm_lpdf(Y[start:end] | Xc[start:end], Intercept, b, sigma);</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     return ptarget;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> data {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   int&lt;lower=1&gt; N;  // total number of observations</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   vector[N] Y;  // response variable</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   int&lt;lower=1&gt; K;  // number of population-level effects</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   matrix[N, K] X;  // population-level design matrix</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   int&lt;lower=1&gt; Kc;  // number of population-level effects after centering</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   int grainsize;  // grainsize for threading</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   int prior_only;  // should the likelihood be ignored?</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> transformed data {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   matrix[N, Kc] Xc;  // centered version of X without an intercept</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   vector[Kc] means_X;  // column means of X before centering</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   array[N] int seq = sequence(1, N);</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   for (i in 2:K) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     means_X[i - 1] = mean(X[, i]);</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     Xc[, i - 1] = X[, i] - means_X[i - 1];</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> parameters {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   vector[Kc] b;  // regression coefficients</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   real Intercept;  // temporary intercept for centered predictors</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   real&lt;lower=0&gt; sigma;  // dispersion parameter</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   real&lt;lower=0&gt; tau;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> transformed parameters {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   // prior contributions to the log posterior</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   real lprior = 0;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   lprior += student_t_lpdf(Intercept | 3, 4, 4.4);</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   lprior += student_t_lpdf(sigma | 3, 0, 4.4)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     - 1 * student_t_lccdf(0 | 3, 0, 4.4);</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> model {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   // likelihood including constants</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   if (!prior_only) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     target += reduce_sum(partial_log_lik_lpmf, seq, grainsize, Y, Xc, b, Intercept, sigma, tau);</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   // priors including constants</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   target += lprior;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> generated quantities {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   // actual population-level intercept</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   real b_Intercept = Intercept - dot_product(means_X, b);</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> }</span>
<span class="r-in"><span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Paul-Christian Bürkner.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer></div>





  </body></html>

