<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><title>K-Fold Cross-Validation — kfold.brmsfit • brms</title><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet"><script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet"><link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet"><script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="K-Fold Cross-Validation — kfold.brmsfit"><meta name="description" content="Perform exact K-fold cross-validation by refitting the model \(K\)
times each leaving out one-\(K\)th of the original data.
Folds can be run in parallel using the future package."><meta property="og:description" content="Perform exact K-fold cross-validation by refitting the model \(K\)
times each leaving out one-\(K\)th of the original data.
Folds can be run in parallel using the future package."></head><body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">brms</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">2.22.12</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"><li class="active nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles"><li><a class="dropdown-item" href="../articles/brms_customfamilies.html">Define Custom Response Distributions with brms</a></li>
    <li><a class="dropdown-item" href="../articles/brms_distreg.html">Estimating Distributional Models with brms</a></li>
    <li><a class="dropdown-item" href="../articles/brms_families.html">Parameterization of Response Distributions in brms</a></li>
    <li><a class="dropdown-item" href="../articles/brms_missings.html">Handle Missing Values with brms</a></li>
    <li><a class="dropdown-item" href="../articles/brms_monotonic.html">Estimating Monotonic Effects with brms</a></li>
    <li><a class="dropdown-item" href="../articles/brms_multivariate.html">Estimating Multivariate Models with brms</a></li>
    <li><a class="dropdown-item" href="../articles/brms_nonlinear.html">Estimating Non-Linear Models with brms</a></li>
    <li><a class="dropdown-item" href="../articles/brms_phylogenetics.html">Estimating Phylogenetic Multilevel Models with brms</a></li>
    <li><a class="dropdown-item" href="../articles/brms_threading.html">Running brms models with within-chain parallelization</a></li>
  </ul></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul><ul class="navbar-nav"><li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json"></form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/paul-buerkner/brms/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul></div>


  </div>
</nav><div class="container template-reference-topic">
<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>K-Fold Cross-Validation</h1>
      <small class="dont-index">Source: <a href="https://github.com/paul-buerkner/brms/blob/HEAD/R/kfold.R" class="external-link"><code>R/kfold.R</code></a></small>
      <div class="d-none name"><code>kfold.brmsfit.Rd</code></div>
    </div>

    <div class="ref-description section level2">
    <p>Perform exact K-fold cross-validation by refitting the model \(K\)
times each leaving out one-\(K\)th of the original data.
Folds can be run in parallel using the <span class="pkg">future</span> package.</p>
    </div>

    <div class="section level2">
    <h2 id="ref-usage">Usage<a class="anchor" aria-label="anchor" href="#ref-usage"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="co"># S3 method for class 'brmsfit'</span></span>
<span><span class="fu">kfold</span><span class="op">(</span></span>
<span>  <span class="va">x</span>,</span>
<span>  <span class="va">...</span>,</span>
<span>  K <span class="op">=</span> <span class="fl">10</span>,</span>
<span>  Ksub <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  folds <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  group <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  joint <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  compare <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  resp <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  model_names <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  save_fits <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>  recompile <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  future_args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div class="section level2">
    <h2 id="arguments">Arguments<a class="anchor" aria-label="anchor" href="#arguments"></a></h2>


<dl><dt id="arg-x">x<a class="anchor" aria-label="anchor" href="#arg-x"></a></dt>
<dd><p>A <code>brmsfit</code> object.</p></dd>


<dt id="arg--">...<a class="anchor" aria-label="anchor" href="#arg--"></a></dt>
<dd><p>Further arguments passed to <code><a href="brm.html">brm</a></code>.</p></dd>


<dt id="arg-k">K<a class="anchor" aria-label="anchor" href="#arg-k"></a></dt>
<dd><p>The number of subsets of equal (if possible) size
into which the data will be partitioned for performing
\(K\)-fold cross-validation. The model is refit <code>K</code> times, each time
leaving out one of the <code>K</code> subsets. If <code>K</code> is equal to the total
number of observations in the data then \(K\)-fold cross-validation is
equivalent to exact leave-one-out cross-validation.</p></dd>


<dt id="arg-ksub">Ksub<a class="anchor" aria-label="anchor" href="#arg-ksub"></a></dt>
<dd><p>Optional number of subsets (of those subsets defined by <code>K</code>)
to be evaluated. If <code>NULL</code> (the default), \(K\)-fold cross-validation
will be performed on all subsets. If <code>Ksub</code> is a single integer,
<code>Ksub</code> subsets (out of all <code>K</code>) subsets will be randomly chosen.
If <code>Ksub</code> consists of multiple integers or a one-dimensional array
(created via <code>as.array</code>) potentially of length one, the corresponding
subsets will be used. This argument is primarily useful, if evaluation of
all subsets is infeasible for some reason.</p></dd>


<dt id="arg-folds">folds<a class="anchor" aria-label="anchor" href="#arg-folds"></a></dt>
<dd><p>Determines how the subsets are being constructed.
Possible values are <code>NULL</code> (the default), <code>"stratified"</code>,
<code>"grouped"</code>, or <code>"loo"</code>. May also be a vector of length
equal to the number of observations in the data. Alters the way
<code>group</code> is handled. More information is provided in the 'Details'
section.</p></dd>


<dt id="arg-group">group<a class="anchor" aria-label="anchor" href="#arg-group"></a></dt>
<dd><p>Optional name of a grouping variable or factor in the model.
What exactly is done with this variable depends on argument <code>folds</code>.
More information is provided in the 'Details' section.</p></dd>


<dt id="arg-joint">joint<a class="anchor" aria-label="anchor" href="#arg-joint"></a></dt>
<dd><p>Indicates which observations' log likelihoods shall be
considered jointly in the ELPD computation. If <code>"obs"</code> or <code>FALSE</code>
(the default), each observation is considered separately. This enables
comparability of <code>kfold</code> with <code>loo</code>. If <code>"fold"</code> or
<code>TRUE</code>, the joint log likelihoods per fold are used. If
<code>"group"</code>, the joint log likelihoods per group within folds are used
(only available if argument <code>group</code> is specified).</p></dd>


<dt id="arg-compare">compare<a class="anchor" aria-label="anchor" href="#arg-compare"></a></dt>
<dd><p>A flag indicating if the information criteria
of the models should be compared to each other
via <code><a href="loo_compare.brmsfit.html">loo_compare</a></code>.</p></dd>


<dt id="arg-resp">resp<a class="anchor" aria-label="anchor" href="#arg-resp"></a></dt>
<dd><p>Optional names of response variables. If specified, predictions
are performed only for the specified response variables.</p></dd>


<dt id="arg-model-names">model_names<a class="anchor" aria-label="anchor" href="#arg-model-names"></a></dt>
<dd><p>If <code>NULL</code> (the default) will use model names
derived from deparsing the call. Otherwise will use the passed
values as model names.</p></dd>


<dt id="arg-save-fits">save_fits<a class="anchor" aria-label="anchor" href="#arg-save-fits"></a></dt>
<dd><p>If <code>TRUE</code>, a component <code>fits</code> is added to
the returned object to store the cross-validated <code>brmsfit</code>
objects and the indices of the omitted observations for each fold.
Defaults to <code>FALSE</code>.</p></dd>


<dt id="arg-recompile">recompile<a class="anchor" aria-label="anchor" href="#arg-recompile"></a></dt>
<dd><p>Logical, indicating whether the Stan model should be
recompiled. This may be necessary if you are running <code>reloo</code> on
another machine than the one used to fit the model.</p></dd>


<dt id="arg-future-args">future_args<a class="anchor" aria-label="anchor" href="#arg-future-args"></a></dt>
<dd><p>A list of further arguments passed to
<code><a href="https://future.futureverse.org/reference/future.html" class="external-link">future</a></code> for additional control over parallel
execution if activated.</p></dd>

</dl></div>
    <div class="section level2">
    <h2 id="value">Value<a class="anchor" aria-label="anchor" href="#value"></a></h2>
    <p><code>kfold</code> returns an object that has a similar structure as the
  objects returned by the <code>loo</code> and <code>waic</code> methods and
  can be used with the same post-processing functions.</p>
    </div>
    <div class="section level2">
    <h2 id="details">Details<a class="anchor" aria-label="anchor" href="#details"></a></h2>
    <p>The <code>kfold</code> function performs exact \(K\)-fold
  cross-validation. First the data are partitioned into \(K\) folds
  (i.e. subsets) of equal (or as close to equal as possible) size by default.
  Then the model is refit \(K\) times, each time leaving out one of the
  <code>K</code> subsets. If \(K\) is equal to the total number of observations
  in the data then \(K\)-fold cross-validation is equivalent to exact
  leave-one-out cross-validation (to which <code>loo</code> is an efficient
  approximation). The <code>compare_ic</code> function is also compatible with
  the objects returned by <code>kfold</code>.</p>
<p>The subsets can be constructed in multiple different ways:</p><ul><li><p>If both <code>folds</code> and <code>group</code> are <code>NULL</code>, the subsets
  are randomly chosen so that they have equal (or as close to equal as
  possible) size.</p></li>
<li><p>If <code>folds</code> is <code>NULL</code> but <code>group</code> is specified, the
  data is split up into subsets, each time omitting all observations of one
  of the factor levels, while ignoring argument <code>K</code>.</p></li>
<li><p>If <code>folds = "stratified"</code> the subsets are stratified after
  <code>group</code> using <code><a href="https://mc-stan.org/loo/reference/kfold-helpers.html" class="external-link">loo::kfold_split_stratified</a></code>.</p></li>
<li><p>If <code>folds = "grouped"</code> the subsets are split by
  <code>group</code> using <code><a href="https://mc-stan.org/loo/reference/kfold-helpers.html" class="external-link">loo::kfold_split_grouped</a></code>.</p></li>
<li><p>If <code>folds = "loo"</code> exact leave-one-out cross-validation
  will be performed and <code>K</code> will be ignored. Further, if <code>group</code>
  is specified, all observations corresponding to the factor level of the
  currently predicted single value are omitted. Thus, in this case, the
  predicted values are only a subset of the omitted ones.</p></li>
<li><p>If <code>folds</code> is a numeric vector, it must contain one element per
  observation in the data. Each element of the vector is an integer in
  <code>1:K</code> indicating to which of the <code>K</code> folds the corresponding
  observation belongs. There are some convenience functions available in
  the <span class="pkg">loo</span> package that create integer vectors to use for this purpose
  (see the Examples section below and also the
  <a href="https://mc-stan.org/loo/reference/kfold-helpers.html" class="external-link">kfold-helpers</a> page).</p></li>
</ul><p>When running <code>kfold</code> on a <code>brmsfit</code> created with the
  <span class="pkg">cmdstanr</span> backend in a different <span style="R">R</span> session, several recompilations
  will be triggered because by default, <span class="pkg">cmdstanr</span> writes the model
  executable to a temporary directory. To avoid that, set option
  <code>"cmdstanr_write_stan_file_dir"</code> to a nontemporary path of your choice
  before creating the original <code>brmsfit</code> (see section 'Examples' below).</p>
    </div>
    <div class="section level2">
    <h2 id="see-also">See also<a class="anchor" aria-label="anchor" href="#see-also"></a></h2>
    <div class="dont-index"><p><code><a href="loo.brmsfit.html">loo</a></code>, <code><a href="reloo.brmsfit.html">reloo</a></code></p></div>
    </div>

    <div class="section level2">
    <h2 id="ref-examples">Examples<a class="anchor" aria-label="anchor" href="#ref-examples"></a></h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="kw">if</span> <span class="op">(</span><span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span> <span class="co"># \dontrun{</span></span></span>
<span class="r-in"><span><span class="va">fit1</span> <span class="op">&lt;-</span> <span class="fu"><a href="brm.html">brm</a></span><span class="op">(</span><span class="va">count</span> <span class="op">~</span> <span class="va">zAge</span> <span class="op">+</span> <span class="va">zBase</span> <span class="op">*</span> <span class="va">Trt</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span><span class="op">|</span><span class="va">patient</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span><span class="op">|</span><span class="va">obs</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>           data <span class="op">=</span> <span class="va">epilepsy</span>, family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">poisson</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="co"># throws warning about some pareto k estimates being too high</span></span></span>
<span class="r-in"><span><span class="op">(</span><span class="va">loo1</span> <span class="op">&lt;-</span> <span class="fu"><a href="loo.brmsfit.html">loo</a></span><span class="op">(</span><span class="va">fit1</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="co"># perform 10-fold cross validation</span></span></span>
<span class="r-in"><span><span class="op">(</span><span class="va">kfold1</span> <span class="op">&lt;-</span> <span class="fu">kfold</span><span class="op">(</span><span class="va">fit1</span>, chains <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># use joint likelihoods per fold for ELPD evaluation</span></span></span>
<span class="r-in"><span><span class="fu">kfold</span><span class="op">(</span><span class="va">fit1</span>, chains <span class="op">=</span> <span class="fl">1</span>, joint <span class="op">=</span> <span class="st">"fold"</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># use the future package for parallelization of models</span></span></span>
<span class="r-in"><span><span class="co"># that is to fit models belonging to different folds in parallel</span></span></span>
<span class="r-in"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://future.futureverse.org" class="external-link">future</a></span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://future.futureverse.org/reference/plan.html" class="external-link">plan</a></span><span class="op">(</span><span class="va">multisession</span>, workers <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu">kfold</span><span class="op">(</span><span class="va">fit1</span>, chains <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://future.futureverse.org/reference/plan.html" class="external-link">plan</a></span><span class="op">(</span><span class="va">sequential</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co">## to avoid recompilations when running kfold() on a 'cmdstanr'-backend fit</span></span></span>
<span class="r-in"><span><span class="co">## in a fresh R session, set option 'cmdstanr_write_stan_file_dir' before</span></span></span>
<span class="r-in"><span><span class="co">## creating the initial 'brmsfit'</span></span></span>
<span class="r-in"><span><span class="co">## CAUTION: the following code creates some files in the current working</span></span></span>
<span class="r-in"><span><span class="co">## directory: two 'model_&lt;hash&gt;.stan' files, one 'model_&lt;hash&gt;(.exe)'</span></span></span>
<span class="r-in"><span><span class="co">## executable, and one 'fit_cmdstanr_&lt;some_number&gt;.rds' file</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">7</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">fname</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"fit_cmdstanr_"</span>, <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample.int</a></span><span class="op">(</span><span class="va">.Machine</span><span class="op">$</span><span class="va">integer.max</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>cmdstanr_write_stan_file_dir <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/getwd.html" class="external-link">getwd</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">fit_cmdstanr</span> <span class="op">&lt;-</span> <span class="fu"><a href="brm.html">brm</a></span><span class="op">(</span><span class="va">rate</span> <span class="op">~</span> <span class="va">conc</span> <span class="op">+</span> <span class="va">state</span>, data <span class="op">=</span> <span class="va">Puromycin</span>,</span></span>
<span class="r-in"><span>                    backend <span class="op">=</span> <span class="st">"cmdstanr"</span>, file <span class="op">=</span> <span class="va">fname</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># now restart the R session and run the following (after attaching 'brms')</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">7</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">fname</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"fit_cmdstanr_"</span>, <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample.int</a></span><span class="op">(</span><span class="va">.Machine</span><span class="op">$</span><span class="va">integer.max</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">fit_cmdstanr</span> <span class="op">&lt;-</span> <span class="fu"><a href="brm.html">brm</a></span><span class="op">(</span><span class="va">rate</span> <span class="op">~</span> <span class="va">conc</span> <span class="op">+</span> <span class="va">state</span>,</span></span>
<span class="r-in"><span>                    data <span class="op">=</span> <span class="va">Puromycin</span>,</span></span>
<span class="r-in"><span>                    backend <span class="op">=</span> <span class="st">"cmdstanr"</span>,</span></span>
<span class="r-in"><span>                    file <span class="op">=</span> <span class="va">fname</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">kfold_cmdstanr</span> <span class="op">&lt;-</span> <span class="fu">kfold</span><span class="op">(</span><span class="va">fit_cmdstanr</span>, K <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="op">}</span> <span class="co"># }</span></span></span>
<span class="r-in"><span></span></span>
</code></pre></div>
    </div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside></div>


    <footer><div class="pkgdown-footer-left">
  <p>Developed by Paul-Christian Bürkner.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer></div>





  </body></html>

