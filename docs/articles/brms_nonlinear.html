<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Estimating Non-Linear Models with brms • brms</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Estimating Non-Linear Models with brms">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">brms</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">2.22.12</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/brms_customfamilies.html">Define Custom Response Distributions with brms</a></li>
    <li><a class="dropdown-item" href="../articles/brms_distreg.html">Estimating Distributional Models with brms</a></li>
    <li><a class="dropdown-item" href="../articles/brms_families.html">Parameterization of Response Distributions in brms</a></li>
    <li><a class="dropdown-item" href="../articles/brms_missings.html">Handle Missing Values with brms</a></li>
    <li><a class="dropdown-item" href="../articles/brms_monotonic.html">Estimating Monotonic Effects with brms</a></li>
    <li><a class="dropdown-item" href="../articles/brms_multivariate.html">Estimating Multivariate Models with brms</a></li>
    <li><a class="dropdown-item" href="../articles/brms_nonlinear.html">Estimating Non-Linear Models with brms</a></li>
    <li><a class="dropdown-item" href="../articles/brms_phylogenetics.html">Estimating Phylogenetic Multilevel Models with brms</a></li>
    <li><a class="dropdown-item" href="../articles/brms_threading.html">Running brms models with within-chain parallelization</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/paul-buerkner/brms/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Estimating Non-Linear Models with brms</h1>
                        <h4 data-toc-skip class="author">Paul
Bürkner</h4>
            
            <h4 data-toc-skip class="date">2025-06-24</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/paul-buerkner/brms/blob/HEAD/vignettes/brms_nonlinear.Rmd" class="external-link"><code>vignettes/brms_nonlinear.Rmd</code></a></small>
      <div class="d-none name"><code>brms_nonlinear.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>This vignette provides an introduction on how to fit non-linear
multilevel models with <strong>brms</strong>. Non-linear models are
incredibly flexible and powerful, but require much more care with
respect to model specification and priors than typical generalized
linear models. Ignoring group-level effects for the moment, the
predictor term
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>η</mi><mi>n</mi></msub><annotation encoding="application/x-tex">\eta_n</annotation></semantics></math>
of a generalized linear model for observation
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>n</mi><annotation encoding="application/x-tex">n</annotation></semantics></math>
can be written as follows:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>η</mi><mi>n</mi></msub><mo>=</mo><munderover><mo>∑</mo><mrow><mi>i</mi><mo>=</mo><mn>1</mn></mrow><mi>K</mi></munderover><msub><mi>b</mi><mi>i</mi></msub><msub><mi>x</mi><mrow><mi>n</mi><mi>i</mi></mrow></msub></mrow><annotation encoding="application/x-tex">\eta_n = \sum_{i = 1}^K b_i x_{ni}</annotation></semantics></math></p>
<p>where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>b</mi><mi>i</mi></msub><annotation encoding="application/x-tex">b_i</annotation></semantics></math>
is the regression coefficient of predictor
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>i</mi><annotation encoding="application/x-tex">i</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>x</mi><mrow><mi>n</mi><mi>i</mi></mrow></msub><annotation encoding="application/x-tex">x_{ni}</annotation></semantics></math>
is the data of predictor
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>i</mi><annotation encoding="application/x-tex">i</annotation></semantics></math>
for observation
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>n</mi><annotation encoding="application/x-tex">n</annotation></semantics></math>.
This also comprises interaction terms and various other data
transformations. However, the structure of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>η</mi><mi>n</mi></msub><annotation encoding="application/x-tex">\eta_n</annotation></semantics></math>
is always linear in the sense that the regression coefficients
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>b</mi><mi>i</mi></msub><annotation encoding="application/x-tex">b_i</annotation></semantics></math>
are multiplied by some predictor values and then summed up. This implies
that the hypothetical predictor term</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>η</mi><mi>n</mi></msub><mo>=</mo><msub><mi>b</mi><mn>1</mn></msub><mo>exp</mo><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>b</mi><mn>2</mn></msub><msub><mi>x</mi><mi>n</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\eta_n = b_1 \exp(b_2 x_n)</annotation></semantics></math></p>
<p>would <em>not</em> be a <em>linear</em> predictor anymore and we
could not fit it using classical techniques of generalized linear
models. We thus need a more general model class, which we will call
<em>non-linear</em> models. Note that the term ‘non-linear’ does not say
anything about the assumed distribution of the response variable. In
particular it does not mean ‘not normally distributed’ as we can apply
non-linear predictor terms to all kinds of response distributions (for
more details on response distributions available in
<strong>brms</strong> see <code><a href="../articles/brms_families.html">vignette("brms_families")</a></code>).</p>
</div>
<div class="section level2">
<h2 id="a-simple-non-linear-model">A Simple Non-Linear Model<a class="anchor" aria-label="anchor" href="#a-simple-non-linear-model"></a>
</h2>
<p>We begin with a simple example using simulated data.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">b</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>, <span class="fl">0.75</span><span class="op">)</span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">100</span>, mean <span class="op">=</span> <span class="va">b</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">b</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">*</span> <span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">dat1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">x</span>, <span class="va">y</span><span class="op">)</span></span></code></pre></div>
<p>As stated above, we cannot use a generalized linear model to estimate
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>b</mi><annotation encoding="application/x-tex">b</annotation></semantics></math>
so we go ahead an specify a non-linear model.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">prior1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span>, nlpar <span class="op">=</span> <span class="st">"b1"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="../reference/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2</span><span class="op">)</span>, nlpar <span class="op">=</span> <span class="st">"b2"</span><span class="op">)</span></span>
<span><span class="va">fit1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/brm.html">brm</a></span><span class="op">(</span><span class="fu"><a href="../reference/brmsformula.html">bf</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">b1</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">b2</span> <span class="op">*</span> <span class="va">x</span><span class="op">)</span>, <span class="va">b1</span> <span class="op">+</span> <span class="va">b2</span> <span class="op">~</span> <span class="fl">1</span>, nl <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>            data <span class="op">=</span> <span class="va">dat1</span>, prior <span class="op">=</span> <span class="va">prior1</span><span class="op">)</span></span></code></pre></div>
<p>When looking at the above code, the first thing that becomes obvious
is that we changed the <code>formula</code> syntax to display the
non-linear formula including predictors (i.e., <code>x</code>) and
parameters (i.e., <code>b1</code> and <code>b2</code>) wrapped in a call
to <code>bf</code>. This stands in contrast to classical
<strong>R</strong> formulas, where only predictors are given and
parameters are implicit. The argument <code>b1 + b2 ~ 1</code> serves
two purposes. First, it provides information, which variables in
<code>formula</code> are parameters, and second, it specifies the linear
predictor terms for each parameter. In fact, we should think of
non-linear parameters as placeholders for linear predictor terms rather
than as parameters themselves (see also the following examples). In the
present case, we have no further variables to predict <code>b1</code>
and <code>b2</code> and thus we just fit intercepts that represent our
estimates of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>b</mi><mn>1</mn></msub><annotation encoding="application/x-tex">b_1</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>b</mi><mn>2</mn></msub><annotation encoding="application/x-tex">b_2</annotation></semantics></math>
in the model equation above. The formula <code>b1 + b2 ~ 1</code> is a
short form of <code>b1 ~ 1, b2 ~ 1</code> that can be used if multiple
non-linear parameters share the same formula. Setting
<code>nl = TRUE</code> tells <strong>brms</strong> that the formula
should be treated as non-linear.</p>
<p>In contrast to generalized linear models, priors on population-level
parameters (i.e., ‘fixed effects’) are often mandatory to identify a
non-linear model. Thus, <strong>brms</strong> requires the user to
explicitly specify these priors. In the present example, we used a
<code>normal(1, 2)</code> prior on (the population-level intercept of)
<code>b1</code>, while we used a <code>normal(0, 2)</code> prior on (the
population-level intercept of) <code>b2</code>. Setting priors is a
non-trivial task in all kinds of models, especially in non-linear
models, so you should always invest some time to think of appropriate
priors. Quite often, you may be forced to change your priors after
fitting a non-linear model for the first time, when you observe
different MCMC chains converging to different posterior regions. This is
a clear sign of an identification problem and one solution is to set
stronger (i.e., more narrow) priors.</p>
<p>To obtain summaries of the fitted model, we apply</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">fit1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="../reference/conditional_effects.brmsfit.html">conditional_effects</a></span><span class="op">(</span><span class="va">fit1</span><span class="op">)</span>, points <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>The <code>summary</code> method reveals that we were able to recover
the true parameter values pretty nicely. According to the
<code>plot</code> method, our MCMC chains have converged well and to the
same posterior. The <code>conditional_effects</code> method visualizes
the model-implied (non-linear) regression line.</p>
<p>We might be also interested in comparing our non-linear model to a
classical linear model.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/brm.html">brm</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">x</span>, data <span class="op">=</span> <span class="va">dat1</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit2</span><span class="op">)</span></span></code></pre></div>
<p>To investigate and compare model fit, we can apply graphical
posterior predictive checks, which make use of the
<strong>bayesplot</strong> package on the backend.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/pp_check.brmsfit.html">pp_check</a></span><span class="op">(</span><span class="va">fit1</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/pp_check.brmsfit.html">pp_check</a></span><span class="op">(</span><span class="va">fit2</span><span class="op">)</span></span></code></pre></div>
<p>We can also easily compare model fit using leave-one-out
cross-validation.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/loo.brmsfit.html">loo</a></span><span class="op">(</span><span class="va">fit1</span>, <span class="va">fit2</span><span class="op">)</span></span></code></pre></div>
<p>Since smaller <code>LOOIC</code> values indicate better model fit, it
is immediately evident that the non-linear model fits the data better,
which is of course not too surprising since we simulated the data from
exactly that model.</p>
</div>
<div class="section level2">
<h2 id="a-real-world-non-linear-model">A Real-World Non-Linear model<a class="anchor" aria-label="anchor" href="#a-real-world-non-linear-model"></a>
</h2>
<p>On his blog, Markus Gesmann predicts the growth of cumulative
insurance loss payments over time, originated from different origin
years (see <a href="https://www.magesblog.com/post/2015-11-03-loss-developments-via-growth-curves-and/" class="external-link uri">https://www.magesblog.com/post/2015-11-03-loss-developments-via-growth-curves-and/</a>).
We will use a slightly simplified version of his model for demonstration
purposes here. It looks as follows:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi><mi>u</mi><msub><mi>m</mi><mrow><mi>A</mi><mi>Y</mi><mo>,</mo><mi>d</mi><mi>e</mi><mi>v</mi></mrow></msub><mo>∼</mo><mi>N</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>μ</mi><mrow><mi>A</mi><mi>Y</mi><mo>,</mo><mi>d</mi><mi>e</mi><mi>v</mi></mrow></msub><mo>,</mo><mi>σ</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">cum_{AY, dev} \sim N(\mu_{AY, dev}, \sigma)</annotation></semantics></math><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>μ</mi><mrow><mi>A</mi><mi>Y</mi><mo>,</mo><mi>d</mi><mi>e</mi><mi>v</mi></mrow></msub><mo>=</mo><mi>u</mi><mi>l</mi><msub><mi>t</mi><mrow><mi>A</mi><mi>Y</mi></mrow></msub><mrow><mo stretchy="true" form="prefix">(</mo><mn>1</mn><mo>−</mo><mo>exp</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>−</mi><msup><mrow><mo stretchy="true" form="prefix">(</mo><mfrac><mrow><mi>d</mi><mi>e</mi><mi>v</mi></mrow><mi>θ</mi></mfrac><mo stretchy="true" form="postfix">)</mo></mrow><mi>ω</mi></msup><mo stretchy="true" form="postfix">)</mo></mrow><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\mu_{AY, dev} = ult_{AY} \left(1 - \exp\left(- \left( \frac{dev}{\theta} \right)^\omega \right) \right)</annotation></semantics></math></p>
<p>The cumulative insurance payments
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi><mi>u</mi><mi>m</mi></mrow><annotation encoding="application/x-tex">cum</annotation></semantics></math>
will grow over time, and we model this dependency using the variable
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>d</mi><mi>e</mi><mi>v</mi></mrow><annotation encoding="application/x-tex">dev</annotation></semantics></math>.
Further,
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>u</mi><mi>l</mi><msub><mi>t</mi><mrow><mi>A</mi><mi>Y</mi></mrow></msub></mrow><annotation encoding="application/x-tex">ult_{AY}</annotation></semantics></math>
is the (to be estimated) ultimate loss of accident each year. It
constitutes a non-linear parameter in our framework along with the
parameters
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>θ</mi><annotation encoding="application/x-tex">\theta</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>ω</mi><annotation encoding="application/x-tex">\omega</annotation></semantics></math>,
which are responsible for the growth of the cumulative loss and are
assumed to be the same across years. The data is already shipped with
brms.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">loss</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">loss</span><span class="op">)</span></span></code></pre></div>
<p>and translate the proposed model into a non-linear
<strong>brms</strong> model.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit_loss</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/brm.html">brm</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="../reference/brmsformula.html">bf</a></span><span class="op">(</span><span class="va">cum</span> <span class="op">~</span> <span class="va">ult</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="op">(</span><span class="va">dev</span><span class="op">/</span><span class="va">theta</span><span class="op">)</span><span class="op">^</span><span class="va">omega</span><span class="op">)</span><span class="op">)</span>,</span>
<span>     <span class="va">ult</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span><span class="op">|</span><span class="va">AY</span><span class="op">)</span>, <span class="va">omega</span> <span class="op">~</span> <span class="fl">1</span>, <span class="va">theta</span> <span class="op">~</span> <span class="fl">1</span>,</span>
<span>     nl <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">loss</span>, family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">gaussian</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="../reference/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">5000</span>, <span class="fl">1000</span><span class="op">)</span>, nlpar <span class="op">=</span> <span class="st">"ult"</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="../reference/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span>, nlpar <span class="op">=</span> <span class="st">"omega"</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="../reference/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">45</span>, <span class="fl">10</span><span class="op">)</span>, nlpar <span class="op">=</span> <span class="st">"theta"</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>adapt_delta <span class="op">=</span> <span class="fl">0.9</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>We estimate a group-level effect of accident year (variable
<code>AY</code>) for the ultimate loss <code>ult</code>. This also shows
nicely how a non-linear parameter is actually a placeholder for a linear
predictor, which in case of <code>ult</code>, contains only an varying
intercept over year. Again, priors on population-level effects are
required and, for the present model, are actually mandatory to ensure
identifiability. We summarize the model using well known methods.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit_loss</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">fit_loss</span>, N <span class="op">=</span> <span class="fl">3</span>, ask <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/conditional_effects.brmsfit.html">conditional_effects</a></span><span class="op">(</span><span class="va">fit_loss</span><span class="op">)</span></span></code></pre></div>
<p>Next, we show marginal effects separately for each year.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">conditions</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>AY <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">loss</span><span class="op">$</span><span class="va">AY</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">conditions</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">loss</span><span class="op">$</span><span class="va">AY</span><span class="op">)</span></span>
<span><span class="va">me_loss</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/conditional_effects.brmsfit.html">conditional_effects</a></span><span class="op">(</span></span>
<span>  <span class="va">fit_loss</span>, conditions <span class="op">=</span> <span class="va">conditions</span>,</span>
<span>  re_formula <span class="op">=</span> <span class="cn">NULL</span>, method <span class="op">=</span> <span class="st">"predict"</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">me_loss</span>, ncol <span class="op">=</span> <span class="fl">5</span>, points <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>It is evident that there is some variation in cumulative loss across
accident years, for instance due to natural disasters happening only in
certain years. Further, we see that the uncertainty in the predicted
cumulative loss is larger for later years with fewer available data
points. For a more detailed discussion of this data set, see Section 4.5
in Gesmann &amp; Morris (2020).</p>
</div>
<div class="section level2">
<h2 id="advanced-item-response-models">Advanced Item-Response Models<a class="anchor" aria-label="anchor" href="#advanced-item-response-models"></a>
</h2>
<p>As a third example, we want to show how to model more advanced
item-response models using the non-linear model framework of
<strong>brms</strong>. For simplicity, suppose we have a single forced
choice item with three alternatives of which only one is correct. Our
response variable is whether a person answers the item correctly (1) or
not (0). Person are assumed to vary in their ability to answer the item
correctly. However, every person has a 33% chance of getting the item
right just by guessing. We thus simulate some data to reflect this
situation.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">inv_logit</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fl">1</span> <span class="op">/</span> <span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="op">-</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">ability</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">300</span><span class="op">)</span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fl">0.33</span> <span class="op">+</span> <span class="fl">0.67</span> <span class="op">*</span> <span class="fu">inv_logit</span><span class="op">(</span><span class="va">ability</span><span class="op">)</span></span>
<span><span class="va">answer</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">300</span>, <span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span> <span class="op">&lt;</span> <span class="va">p</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">dat_ir</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">ability</span>, <span class="va">answer</span><span class="op">)</span></span></code></pre></div>
<p>The most basic item-response model is equivalent to a simple logistic
regression model.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit_ir1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/brm.html">brm</a></span><span class="op">(</span><span class="va">answer</span> <span class="op">~</span> <span class="va">ability</span>, data <span class="op">=</span> <span class="va">dat_ir</span>, family <span class="op">=</span> <span class="fu"><a href="../reference/brmsfamily.html">bernoulli</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>However, this model completely ignores the guessing probability and
will thus likely come to biased estimates and predictions.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit_ir1</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="../reference/conditional_effects.brmsfit.html">conditional_effects</a></span><span class="op">(</span><span class="va">fit_ir1</span><span class="op">)</span>, points <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>A more sophisticated approach incorporating the guessing probability
looks as follows:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit_ir2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/brm.html">brm</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="../reference/brmsformula.html">bf</a></span><span class="op">(</span><span class="va">answer</span> <span class="op">~</span> <span class="fl">0.33</span> <span class="op">+</span> <span class="fl">0.67</span> <span class="op">*</span> <span class="fu">inv_logit</span><span class="op">(</span><span class="va">eta</span><span class="op">)</span>,</span>
<span>     <span class="va">eta</span> <span class="op">~</span> <span class="va">ability</span>, nl <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">dat_ir</span>, family <span class="op">=</span> <span class="fu"><a href="../reference/brmsfamily.html">bernoulli</a></span><span class="op">(</span><span class="st">"identity"</span><span class="op">)</span>,</span>
<span>  prior <span class="op">=</span> <span class="fu"><a href="../reference/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">5</span><span class="op">)</span>, nlpar <span class="op">=</span> <span class="st">"eta"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>It is very important to set the link function of the
<code>bernoulli</code> family to <code>identity</code> or else we will
apply two link functions. This is because our non-linear predictor term
already contains the desired link function
(<code>0.33 + 0.67 * inv_logit</code>), but the <code>bernoulli</code>
family applies the default <code>logit</code> link on top of it. This
will of course lead to strange and uninterpretable results. Thus, please
make sure that you set the link function to <code>identity</code>,
whenever your non-linear predictor term already contains the desired
link function.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit_ir2</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="../reference/conditional_effects.brmsfit.html">conditional_effects</a></span><span class="op">(</span><span class="va">fit_ir2</span><span class="op">)</span>, points <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>Comparing model fit via leave-one-out cross-validation</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/loo.brmsfit.html">loo</a></span><span class="op">(</span><span class="va">fit_ir1</span>, <span class="va">fit_ir2</span><span class="op">)</span></span></code></pre></div>
<p>shows that both model fit the data equally well, but remember that
predictions of the first model might still be misleading as they may
well be below the guessing probability for low ability values. Now,
suppose that we don’t know the guessing probability and want to estimate
it from the data. This can easily be done changing the previous model
just a bit.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit_ir3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/brm.html">brm</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="../reference/brmsformula.html">bf</a></span><span class="op">(</span><span class="va">answer</span> <span class="op">~</span> <span class="va">guess</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">guess</span><span class="op">)</span> <span class="op">*</span> <span class="fu">inv_logit</span><span class="op">(</span><span class="va">eta</span><span class="op">)</span>,</span>
<span>    <span class="va">eta</span> <span class="op">~</span> <span class="fl">0</span> <span class="op">+</span> <span class="va">ability</span>, <span class="va">guess</span> <span class="op">~</span> <span class="fl">1</span>, nl <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">dat_ir</span>, family <span class="op">=</span> <span class="fu"><a href="../reference/brmsfamily.html">bernoulli</a></span><span class="op">(</span><span class="st">"identity"</span><span class="op">)</span>,</span>
<span>  prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="../reference/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">5</span><span class="op">)</span>, nlpar <span class="op">=</span> <span class="st">"eta"</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="../reference/set_prior.html">prior</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Special.html" class="external-link">beta</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span>, nlpar <span class="op">=</span> <span class="st">"guess"</span>, lb <span class="op">=</span> <span class="fl">0</span>, ub <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Here, we model the guessing probability as a non-linear parameter
making sure that it cannot exceed the interval
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="true" form="prefix">[</mo><mn>0</mn><mo>,</mo><mn>1</mn><mo stretchy="true" form="postfix">]</mo></mrow><annotation encoding="application/x-tex">[0, 1]</annotation></semantics></math>.
We did not estimate an intercept for <code>eta</code>, as this will lead
to a bias in the estimated guessing parameter (try it out; this is an
excellent example of how careful one has to be in non-linear
models).</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">fit_ir3</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">fit_ir3</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="../reference/conditional_effects.brmsfit.html">conditional_effects</a></span><span class="op">(</span><span class="va">fit_ir3</span><span class="op">)</span>, points <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>The results show that we are able to recover the simulated model
parameters with this non-linear model. Of course, real item-response
data have multiple items so that accounting for item and person
variability (e.g., using a multilevel model with varying intercepts)
becomes necessary as we have multiple observations per item and person.
Luckily, this can all be done within the non-linear framework of
<strong>brms</strong> and I hope that this vignette serves as a good
starting point.</p>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<p>Gesmann M. &amp; Morris J. (2020). Hierarchical Compartmental
Reserving Models. <em>CAS Research Papers</em>.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Paul-Christian Bürkner.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
