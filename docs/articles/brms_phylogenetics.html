<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Estimating Phylogenetic Multilevel Models with brms • brms</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Estimating Phylogenetic Multilevel Models with brms">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">brms</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">2.22.12</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/brms_customfamilies.html">Define Custom Response Distributions with brms</a></li>
    <li><a class="dropdown-item" href="../articles/brms_distreg.html">Estimating Distributional Models with brms</a></li>
    <li><a class="dropdown-item" href="../articles/brms_families.html">Parameterization of Response Distributions in brms</a></li>
    <li><a class="dropdown-item" href="../articles/brms_missings.html">Handle Missing Values with brms</a></li>
    <li><a class="dropdown-item" href="../articles/brms_monotonic.html">Estimating Monotonic Effects with brms</a></li>
    <li><a class="dropdown-item" href="../articles/brms_multivariate.html">Estimating Multivariate Models with brms</a></li>
    <li><a class="dropdown-item" href="../articles/brms_nonlinear.html">Estimating Non-Linear Models with brms</a></li>
    <li><a class="dropdown-item" href="../articles/brms_phylogenetics.html">Estimating Phylogenetic Multilevel Models with brms</a></li>
    <li><a class="dropdown-item" href="../articles/brms_threading.html">Running brms models with within-chain parallelization</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/paul-buerkner/brms/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Estimating Phylogenetic Multilevel Models with brms</h1>
                        <h4 data-toc-skip class="author">Paul
Bürkner</h4>
            
            <h4 data-toc-skip class="date">2025-06-24</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/paul-buerkner/brms/blob/HEAD/vignettes/brms_phylogenetics.Rmd" class="external-link"><code>vignettes/brms_phylogenetics.Rmd</code></a></small>
      <div class="d-none name"><code>brms_phylogenetics.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>In the present vignette, we want to discuss how to specify
phylogenetic multilevel models using <strong>brms</strong>. These models
are relevant in evolutionary biology when data of many species are
analyzed at the same time. The usual approach would be to model species
as a grouping factor in a multilevel model and estimate varying
intercepts (and possibly also varying slopes) over species. However,
species are not independent as they come from the same phylogenetic tree
and we thus have to adjust our model to incorporate this dependency. The
examples discussed here are from chapter 11 of the book <em>Modern
Phylogenetic Comparative Methods and the application in Evolutionary
Biology</em> (de Villemeruil &amp; Nakagawa, 2014). The necessary data
can be downloaded from the corresponding website (<a href="https://www.mpcm-evolution.com/" class="external-link uri">https://www.mpcm-evolution.com/</a>). Some of these models
may take a few minutes to fit.</p>
</div>
<div class="section level2">
<h2 id="a-simple-phylogenetic-model">A Simple Phylogenetic Model<a class="anchor" aria-label="anchor" href="#a-simple-phylogenetic-model"></a>
</h2>
<p>Assume we have measurements of a phenotype, <code>phen</code> (say
the body size), and a <code>cofactor</code> variable (say the
temperature of the environment). We prepare the data using the following
code.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">phylo</span> <span class="op">&lt;-</span> <span class="fu">ape</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/read.nexus.html" class="external-link">read.nexus</a></span><span class="op">(</span><span class="st">"https://paul-buerkner.github.io/data/phylo.nex"</span><span class="op">)</span></span>
<span><span class="va">data_simple</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.table</a></span><span class="op">(</span></span>
<span>  <span class="st">"https://paul-buerkner.github.io/data/data_simple.txt"</span>,</span>
<span>  header <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">data_simple</span><span class="op">)</span></span></code></pre></div>
<p>The <code>phylo</code> object contains information on the
relationship between species. Using this information, we can construct a
covariance matrix of species (Hadfield &amp; Nakagawa, 2010).</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">A</span> <span class="op">&lt;-</span> <span class="fu">ape</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/vcv.phylo.html" class="external-link">vcv.phylo</a></span><span class="op">(</span><span class="va">phylo</span><span class="op">)</span></span></code></pre></div>
<p>Now we are ready to fit our first phylogenetic multilevel model:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model_simple</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/brm.html">brm</a></span><span class="op">(</span></span>
<span>  <span class="va">phen</span> <span class="op">~</span> <span class="va">cofactor</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span><span class="op">|</span><span class="fu"><a href="../reference/gr.html">gr</a></span><span class="op">(</span><span class="va">phylo</span>, cov <span class="op">=</span> <span class="va">A</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">data_simple</span>,</span>
<span>  family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">gaussian</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  data2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>A <span class="op">=</span> <span class="va">A</span><span class="op">)</span>,</span>
<span>  prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="../reference/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">10</span><span class="op">)</span>, <span class="st">"b"</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="../reference/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">50</span><span class="op">)</span>, <span class="st">"Intercept"</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="../reference/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">student_t</span><span class="op">(</span><span class="fl">3</span>, <span class="fl">0</span>, <span class="fl">20</span><span class="op">)</span>, <span class="st">"sd"</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="../reference/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">student_t</span><span class="op">(</span><span class="fl">3</span>, <span class="fl">0</span>, <span class="fl">20</span><span class="op">)</span>, <span class="st">"sigma"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>With the exception of <code>(1|gr(phylo, cov = A))</code> instead of
<code>(1|phylo)</code> this is a basic multilevel model with a varying
intercept over species (<code>phylo</code> is an indicator of species in
this data set). However, by using <code>cov = A</code> in the
<code>gr</code> function, we make sure that species are correlated as
specified by the covariance matrix <code>A</code>. We pass
<code>A</code> itself via the <code>data2</code> argument which can be
used for any kinds of data that does not fit into the regular structure
of the <code>data</code> argument. Setting priors is not required for
achieving good convergence for this model, but it improves sampling
speed a bit. After fitting, the results can be investigated in
detail.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">model_simple</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">model_simple</span>, N <span class="op">=</span> <span class="fl">2</span>, ask <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="../reference/conditional_effects.brmsfit.html">conditional_effects</a></span><span class="op">(</span><span class="va">model_simple</span><span class="op">)</span>, points <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>The so called phylogenetic signal (often symbolize by
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>λ</mi><annotation encoding="application/x-tex">\lambda</annotation></semantics></math>)
can be computed with the <code>hypothesis</code> method and is roughly
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>λ</mi><mo>=</mo><mn>0.7</mn></mrow><annotation encoding="application/x-tex">\lambda = 0.7</annotation></semantics></math>
for this example.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hyp</span> <span class="op">&lt;-</span> <span class="st">"sd_phylo__Intercept^2 / (sd_phylo__Intercept^2 + sigma^2) = 0"</span></span>
<span><span class="op">(</span><span class="va">hyp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/hypothesis.brmsfit.html">hypothesis</a></span><span class="op">(</span><span class="va">model_simple</span>, <span class="va">hyp</span>, class <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">hyp</span><span class="op">)</span></span></code></pre></div>
<p>Note that the phylogenetic signal is just a synonym of the
intra-class correlation (ICC) used in the context phylogenetic
analysis.</p>
</div>
<div class="section level2">
<h2 id="a-phylogenetic-model-with-repeated-measurements">A Phylogenetic Model with Repeated Measurements<a class="anchor" aria-label="anchor" href="#a-phylogenetic-model-with-repeated-measurements"></a>
</h2>
<p>Often, we have multiple observations per species and this allows to
fit more complicated phylogenetic models.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data_repeat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.table</a></span><span class="op">(</span></span>
<span>  <span class="st">"https://paul-buerkner.github.io/data/data_repeat.txt"</span>,</span>
<span>  header <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span><span class="va">data_repeat</span><span class="op">$</span><span class="va">spec_mean_cf</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">with</a></span><span class="op">(</span><span class="va">data_repeat</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/split.html" class="external-link">split</a></span><span class="op">(</span><span class="va">cofactor</span>, <span class="va">phylo</span><span class="op">)</span>, <span class="va">mean</span><span class="op">)</span><span class="op">[</span><span class="va">phylo</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">data_repeat</span><span class="op">)</span></span></code></pre></div>
<p>The variable <code>spec_mean_cf</code> just contains the mean of the
cofactor for each species. The code for the repeated measurement
phylogenetic model looks as follows:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model_repeat1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/brm.html">brm</a></span><span class="op">(</span></span>
<span>  <span class="va">phen</span> <span class="op">~</span> <span class="va">spec_mean_cf</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span><span class="op">|</span><span class="fu"><a href="../reference/gr.html">gr</a></span><span class="op">(</span><span class="va">phylo</span>, cov <span class="op">=</span> <span class="va">A</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span><span class="op">|</span><span class="va">species</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">data_repeat</span>,</span>
<span>  family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">gaussian</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  data2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>A <span class="op">=</span> <span class="va">A</span><span class="op">)</span>,</span>
<span>  prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="../reference/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>,<span class="fl">10</span><span class="op">)</span>, <span class="st">"b"</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="../reference/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>,<span class="fl">50</span><span class="op">)</span>, <span class="st">"Intercept"</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="../reference/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">student_t</span><span class="op">(</span><span class="fl">3</span>,<span class="fl">0</span>,<span class="fl">20</span><span class="op">)</span>, <span class="st">"sd"</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="../reference/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">student_t</span><span class="op">(</span><span class="fl">3</span>,<span class="fl">0</span>,<span class="fl">20</span><span class="op">)</span>, <span class="st">"sigma"</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  sample_prior <span class="op">=</span> <span class="cn">TRUE</span>, chains <span class="op">=</span> <span class="fl">2</span>, cores <span class="op">=</span> <span class="fl">2</span>,</span>
<span>  iter <span class="op">=</span> <span class="fl">4000</span>, warmup <span class="op">=</span> <span class="fl">1000</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>The variables <code>phylo</code> and <code>species</code> are
identical as they are both identifiers of the species. However, we model
the phylogenetic covariance only for <code>phylo</code> and thus the
<code>species</code> variable accounts for any specific effect that
would be independent of the phylogenetic relationship between species
(e.g., environmental or niche effects). Again we can obtain model
summaries as well as estimates of the phylogenetic signal.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">model_repeat1</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hyp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span></span>
<span>  <span class="st">"sd_phylo__Intercept^2 /"</span>,</span>
<span>  <span class="st">"(sd_phylo__Intercept^2 + sd_species__Intercept^2 + sigma^2) = 0"</span></span>
<span><span class="op">)</span></span>
<span><span class="op">(</span><span class="va">hyp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/hypothesis.brmsfit.html">hypothesis</a></span><span class="op">(</span><span class="va">model_repeat1</span>, <span class="va">hyp</span>, class <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">hyp</span><span class="op">)</span></span></code></pre></div>
<p>So far, we have completely ignored the variability of the cofactor
within species. To incorporate this into the model, we define</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data_repeat</span><span class="op">$</span><span class="va">within_spec_cf</span> <span class="op">&lt;-</span> <span class="va">data_repeat</span><span class="op">$</span><span class="va">cofactor</span> <span class="op">-</span> <span class="va">data_repeat</span><span class="op">$</span><span class="va">spec_mean_cf</span></span></code></pre></div>
<p>and then fit it again using <code>within_spec_cf</code> as an
additional predictor.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model_repeat2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/update.html" class="external-link">update</a></span><span class="op">(</span></span>
<span>  <span class="va">model_repeat1</span>, formula <span class="op">=</span> <span class="op">~</span> <span class="va">.</span> <span class="op">+</span> <span class="va">within_spec_cf</span>,</span>
<span>  newdata <span class="op">=</span> <span class="va">data_repeat</span>, chains <span class="op">=</span> <span class="fl">2</span>, cores <span class="op">=</span> <span class="fl">2</span>,</span>
<span>  iter <span class="op">=</span> <span class="fl">4000</span>, warmup <span class="op">=</span> <span class="fl">1000</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>The results are almost unchanged, with apparently no relationship
between the phenotype and the within species variance of
<code>cofactor</code>.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">model_repeat2</span><span class="op">)</span></span></code></pre></div>
<p>Also, the phylogenetic signal remains more or less the same.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hyp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span></span>
<span>  <span class="st">"sd_phylo__Intercept^2 /"</span>,</span>
<span>  <span class="st">"(sd_phylo__Intercept^2 + sd_species__Intercept^2 + sigma^2) = 0"</span></span>
<span><span class="op">)</span></span>
<span><span class="op">(</span><span class="va">hyp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/hypothesis.brmsfit.html">hypothesis</a></span><span class="op">(</span><span class="va">model_repeat2</span>, <span class="va">hyp</span>, class <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="a-phylogenetic-meta-analysis">A Phylogenetic Meta-Analysis<a class="anchor" aria-label="anchor" href="#a-phylogenetic-meta-analysis"></a>
</h2>
<p>Let’s say we have Fisher’s z-transformed correlation coefficients
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Z</mi><mi>r</mi></mrow><annotation encoding="application/x-tex">Zr</annotation></semantics></math>
per species along with corresponding sample sizes (e.g., correlations
between male coloration and reproductive success):</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data_fisher</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.table</a></span><span class="op">(</span></span>
<span>  <span class="st">"https://paul-buerkner.github.io/data/data_effect.txt"</span>,</span>
<span>  header <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span><span class="va">data_fisher</span><span class="op">$</span><span class="va">obs</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">data_fisher</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">data_fisher</span><span class="op">)</span></span></code></pre></div>
<p>We assume the sampling variance to be known and as
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>Z</mi><mi>r</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>=</mo><mfrac><mn>1</mn><mrow><mi>N</mi><mo>−</mo><mn>3</mn></mrow></mfrac></mrow><annotation encoding="application/x-tex">V(Zr) = \frac{1}{N - 3}</annotation></semantics></math>
for Fisher’s values, where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>N</mi><annotation encoding="application/x-tex">N</annotation></semantics></math>
is the sample size per species. Incorporating the known sampling
variance into the model is straight forward. One has to keep in mind
though, that <strong>brms</strong> requires the sampling standard
deviation (square root of the variance) as input instead of the variance
itself. The group-level effect of <code>obs</code> represents the
residual variance, which we have to model explicitly in a meta-analytic
model.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model_fisher</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/brm.html">brm</a></span><span class="op">(</span></span>
<span>  <span class="va">Zr</span> <span class="op">|</span> <span class="fu"><a href="../reference/addition-terms.html">se</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">/</span> <span class="op">(</span><span class="va">N</span> <span class="op">-</span> <span class="fl">3</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span><span class="op">|</span><span class="fu"><a href="../reference/gr.html">gr</a></span><span class="op">(</span><span class="va">phylo</span>, cov <span class="op">=</span> <span class="va">A</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span><span class="op">|</span><span class="va">obs</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">data_fisher</span>, family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">gaussian</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  data2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>A <span class="op">=</span> <span class="va">A</span><span class="op">)</span>,</span>
<span>  prior <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="../reference/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="fl">0</span>, <span class="fl">10</span><span class="op">)</span>, <span class="st">"Intercept"</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="../reference/set_prior.html">prior</a></span><span class="op">(</span><span class="fu">student_t</span><span class="op">(</span><span class="fl">3</span>, <span class="fl">0</span>, <span class="fl">10</span><span class="op">)</span>, <span class="st">"sd"</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>adapt_delta <span class="op">=</span> <span class="fl">0.95</span><span class="op">)</span>,</span>
<span>  chains <span class="op">=</span> <span class="fl">2</span>, cores <span class="op">=</span> <span class="fl">2</span>, iter <span class="op">=</span> <span class="fl">4000</span>, warmup <span class="op">=</span> <span class="fl">1000</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>A summary of the fitted model is obtained via</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">model_fisher</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">model_fisher</span><span class="op">)</span></span></code></pre></div>
<p>The meta-analytic mean (i.e., the model intercept) is
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mn>0.16</mn><annotation encoding="application/x-tex">0.16</annotation></semantics></math>
with a credible interval of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="true" form="prefix">[</mo><mn>0.08</mn><mo>,</mo><mn>0.25</mn><mo stretchy="true" form="postfix">]</mo></mrow><annotation encoding="application/x-tex">[0.08, 0.25]</annotation></semantics></math>.
Thus the mean correlation across species is positive according to the
model.</p>
</div>
<div class="section level2">
<h2 id="a-phylogenetic-count-data-model">A phylogenetic count-data model<a class="anchor" aria-label="anchor" href="#a-phylogenetic-count-data-model"></a>
</h2>
<p>Suppose that we analyze a phenotype that consists of counts instead
of being a continuous variable. In such a case, the normality assumption
will likely not be justified and it is recommended to use a distribution
explicitly suited for count data, for instance the Poisson distribution.
The following data set (again retrieved from mpcm-evolution.org)
provides an example.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data_pois</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/read.table.html" class="external-link">read.table</a></span><span class="op">(</span></span>
<span>  <span class="st">"https://paul-buerkner.github.io/data/data_pois.txt"</span>,</span>
<span>  header <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span><span class="va">data_pois</span><span class="op">$</span><span class="va">obs</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">data_pois</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">data_pois</span><span class="op">)</span></span></code></pre></div>
<p>As the Poisson distribution does not have a natural overdispersion
parameter, we model the residual variance via the group-level effects of
<code>obs</code> (e.g., see Lawless, 1987).</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model_pois</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/brm.html">brm</a></span><span class="op">(</span></span>
<span>  <span class="va">phen_pois</span> <span class="op">~</span> <span class="va">cofactor</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span><span class="op">|</span><span class="fu"><a href="../reference/gr.html">gr</a></span><span class="op">(</span><span class="va">phylo</span>, cov <span class="op">=</span> <span class="va">A</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span><span class="op">|</span><span class="va">obs</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">data_pois</span>, family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">poisson</a></span><span class="op">(</span><span class="st">"log"</span><span class="op">)</span>,</span>
<span>  data2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>A <span class="op">=</span> <span class="va">A</span><span class="op">)</span>,</span>
<span>  chains <span class="op">=</span> <span class="fl">2</span>, cores <span class="op">=</span> <span class="fl">2</span>, iter <span class="op">=</span> <span class="fl">4000</span>,</span>
<span>  control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>adapt_delta <span class="op">=</span> <span class="fl">0.95</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Again, we obtain a summary of the fitted model via</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">model_pois</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu"><a href="../reference/conditional_effects.brmsfit.html">conditional_effects</a></span><span class="op">(</span><span class="va">model_pois</span><span class="op">)</span>, points <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>Now, assume we ignore the fact that the phenotype is count data and
fit a linear normal model instead.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model_normal</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/brm.html">brm</a></span><span class="op">(</span></span>
<span>  <span class="va">phen_pois</span> <span class="op">~</span> <span class="va">cofactor</span> <span class="op">+</span> <span class="op">(</span><span class="fl">1</span><span class="op">|</span><span class="fu"><a href="../reference/gr.html">gr</a></span><span class="op">(</span><span class="va">phylo</span>, cov <span class="op">=</span> <span class="va">A</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">data_pois</span>, family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">gaussian</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  data2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>A <span class="op">=</span> <span class="va">A</span><span class="op">)</span>,</span>
<span>  chains <span class="op">=</span> <span class="fl">2</span>, cores <span class="op">=</span> <span class="fl">2</span>, iter <span class="op">=</span> <span class="fl">4000</span>,</span>
<span>  control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>adapt_delta <span class="op">=</span> <span class="fl">0.95</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">model_normal</span><span class="op">)</span></span></code></pre></div>
<p>We see that <code>cofactor</code> has a positive relationship with
the phenotype in both models. One should keep in mind, though, that the
estimates of the Poisson model are on the log-scale, as we applied the
canonical log-link function in this example. Therefore, estimates are
not comparable to a linear normal model even if applied to the same
data. What we can compare, however, is the model fit, for instance
graphically via posterior predictive checks.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/pp_check.brmsfit.html">pp_check</a></span><span class="op">(</span><span class="va">model_pois</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/pp_check.brmsfit.html">pp_check</a></span><span class="op">(</span><span class="va">model_normal</span><span class="op">)</span></span></code></pre></div>
<p>Apparently, the distribution of the phenotype predicted by the
Poisson model resembles the original distribution of the phenotype
pretty closely, while the normal models fails to do so. We can also
apply leave-one-out cross-validation for direct numerical comparison of
model fit.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/loo.brmsfit.html">loo</a></span><span class="op">(</span><span class="va">model_pois</span>, <span class="va">model_normal</span><span class="op">)</span></span></code></pre></div>
<p>Since smaller values of loo indicate better fit, it is again evident
that the Poisson model fits the data better than the normal model. Of
course, the Poisson model is not the only reasonable option here. For
instance, you could use a negative binomial model (via family
<code>negative_binomial</code>), which already contains an
overdispersion parameter so that modeling a varying intercept of
<code>obs</code> becomes obsolete.</p>
</div>
<div class="section level2">
<h2 id="phylogenetic-models-with-multiple-group-level-effects">Phylogenetic models with multiple group-level effects<a class="anchor" aria-label="anchor" href="#phylogenetic-models-with-multiple-group-level-effects"></a>
</h2>
<p>In the above examples, we have only used a single group-level effect
(i.e., a varying intercept) for the phylogenetic grouping factors. In
<strong>brms</strong>, it is also possible to estimate multiple
group-level effects (e.g., a varying intercept and a varying slope) for
these grouping factors. However, it requires repeatedly computing
Kronecker products of covariance matrices while fitting the model. This
will be very slow especially when the grouping factors have many levels
and matrices are thus large.</p>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<p>de Villemeruil P. &amp; Nakagawa, S. (2014) General quantitative
genetic methods for comparative biology. In: <em>Modern phylogenetic
comparative methods and their application in evolutionary biology:
concepts and practice</em> (ed. Garamszegi L.) Springer, New York.
pp. 287-303.</p>
<p>Hadfield, J. D. &amp; Nakagawa, S. (2010) General quantitative
genetic methods for comparative biology: phylogenies, taxonomies, and
multi-trait models for continuous and categorical characters.
<em>Journal of Evolutionary Biology</em>. 23. 494-508.</p>
<p>Lawless, J. F. (1987). Negative binomial and mixed Poisson
regression. <em>Canadian Journal of Statistics</em>, 15(3), 209-225.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Paul-Christian Bürkner.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
