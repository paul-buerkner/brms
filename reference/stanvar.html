<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>User-defined variables passed to Stan — stanvar • brms</title><!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png"><link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png"><link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png"><link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png"><link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png"><link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png"><!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/cosmo/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous"><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css"><script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet"><script src="../pkgdown.js"></script><meta property="og:title" content="User-defined variables passed to Stan — stanvar"><meta property="og:description" content="Prepare user-defined variables to be passed to one of Stan's
program blocks. This is primarily useful for defining more complex
priors, for refitting models without recompilation despite
changing priors, or for defining custom Stan functions."><meta property="og:image" content="/logo.png"><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body data-spy="scroll" data-target="#toc">
    

    <div class="container template-reference-topic">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">brms</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">2.21.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav"><li>
  <a href="../articles/index.html">Vignettes</a>
</li>
<li>
  <a href="../reference/index.html">Functions</a>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Other Packages
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu"><li>
      <a href="http://mc-stan.org/rstan" class="external-link">rstan</a>
    </li>
    <li>
      <a href="http://mc-stan.org/rstanarm" class="external-link">rstanarm</a>
    </li>
    <li>
      <a href="http://mc-stan.org/bayesplot" class="external-link">bayesplot</a>
    </li>
    <li>
      <a href="http://mc-stan.org/shinystan" class="external-link">shinystan</a>
    </li>
    <li>
      <a href="http://mc-stan.org/loo" class="external-link">loo</a>
    </li>
    <li>
      <a href="http://mc-stan.org/projpred" class="external-link">projpred</a>
    </li>
    <li>
      <a href="http://mc-stan.org/rstantools" class="external-link">rstantools</a>
    </li>
  </ul></li>
<li>
  <a href="http://mc-stan.org" class="external-link">Stan</a>
</li>
      </ul><ul class="nav navbar-nav navbar-right"><li>
  <a href="https://twitter.com/mcmc_stan" class="external-link">
    <span class="fa fa-twitter"></span>
     
  </a>
</li>
<li>
  <a href="https://github.com/paul-buerkner/brms" class="external-link">
    <span class="fa fa-github"></span>
     
  </a>
</li>
<li>
  <a href="http://discourse.mc-stan.org/" class="external-link">
    <span class="fa fa-users"></span>
     
  </a>
</li>
      </ul></div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>User-defined variables passed to Stan</h1>
    <small class="dont-index">Source: <a href="https://github.com/paul-buerkner/brms/blob/HEAD/R/stanvars.R" class="external-link"><code>R/stanvars.R</code></a></small>
    <div class="hidden name"><code>stanvar.Rd</code></div>
    </div>

    <div class="ref-description">
    <p>Prepare user-defined variables to be passed to one of Stan's
program blocks. This is primarily useful for defining more complex
priors, for refitting models without recompilation despite
changing priors, or for defining custom Stan functions.</p>
    </div>

    <div id="ref-usage">
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">stanvar</span><span class="op">(</span></span>
<span>  x <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  name <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  scode <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  block <span class="op">=</span> <span class="st">"data"</span>,</span>
<span>  position <span class="op">=</span> <span class="st">"start"</span>,</span>
<span>  pll_args <span class="op">=</span> <span class="cn">NULL</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div id="arguments">
    <h2>Arguments</h2>
    <dl><dt>x</dt>
<dd><p>An <span style="R">R</span> object containing data to be passed to Stan.
Only required if <code>block = 'data'</code> and ignored otherwise.</p></dd>


<dt>name</dt>
<dd><p>Optional character string providing the desired variable
name of the object in <code>x</code>. If <code>NULL</code> (the default)
the variable name is directly inferred from <code>x</code>.</p></dd>


<dt>scode</dt>
<dd><p>Line of Stan code to define the variable
in Stan language. If <code>block = 'data'</code>, the
Stan code is inferred based on the class of <code>x</code> by default.</p></dd>


<dt>block</dt>
<dd><p>Name of one of Stan's program blocks in
which the variable should be defined. Can be <code>'data'</code>,
<code>'tdata'</code> (transformed data), <code>'parameters'</code>,
<code>'tparameters'</code> (transformed parameters), <code>'model'</code>,
<code>'likelihood'</code> (part of the model block where the likelihood is given),
<code>'genquant'</code> (generated quantities) or <code>'functions'</code>.</p></dd>


<dt>position</dt>
<dd><p>Name of the position within the block where the
Stan code should be placed. Currently allowed are <code>'start'</code>
(the default) and <code>'end'</code> of the block.</p></dd>


<dt>pll_args</dt>
<dd><p>Optional Stan code to be put into the header
of <code>partial_log_lik</code> functions. This ensures that the variables
specified in <code>scode</code> can be used in the likelihood even when
within-chain parallelization is activated via <code><a href="threading.html">threading</a></code>.</p></dd>

</dl></div>
    <div id="value">
    <h2>Value</h2>
    

<p>An object of class <code>stanvars</code>.</p>
    </div>
    <div id="details">
    <h2>Details</h2>
    <p>The <code>stanvar</code> function is not vectorized. Instead, multiple
<code>stanvars</code> objects can be added together via <code>+</code> (see Examples).</p>
<p>Special attention is necessary when using <code>stanvars</code> to inject
code into the <code>'likelihood'</code> block while having <code><a href="threading.html">threading</a></code>
activated. In this case, your custom Stan code may need adjustments to ensure
correct observation indexing. Please investigate the generated Stan code via
<code><a href="stancode.default.html">stancode</a></code> to see which adjustments are necessary in your case.</p>
    </div>

    <div id="ref-examples">
    <h2>Examples</h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="va">bprior</span> <span class="op">&lt;-</span> <span class="fu"><a href="set_prior.html">prior</a></span><span class="op">(</span><span class="fu">normal</span><span class="op">(</span><span class="va">mean_intercept</span>, <span class="fl">10</span><span class="op">)</span>, class <span class="op">=</span> <span class="st">"Intercept"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">stanvars</span> <span class="op">&lt;-</span> <span class="fu">stanvar</span><span class="op">(</span><span class="fl">5</span>, name <span class="op">=</span> <span class="st">"mean_intercept"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="stancode.html">stancode</a></span><span class="op">(</span><span class="va">count</span> <span class="op">~</span> <span class="va">Trt</span>, <span class="va">epilepsy</span>, prior <span class="op">=</span> <span class="va">bprior</span>,</span></span>
<span class="r-in"><span>         stanvars <span class="op">=</span> <span class="va">stanvars</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> // generated with brms 2.21.0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> functions {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> data {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   int&lt;lower=1&gt; N;  // total number of observations</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   vector[N] Y;  // response variable</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   int&lt;lower=1&gt; K;  // number of population-level effects</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   matrix[N, K] X;  // population-level design matrix</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   int&lt;lower=1&gt; Kc;  // number of population-level effects after centering</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   int prior_only;  // should the likelihood be ignored?</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   real mean_intercept;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> transformed data {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   matrix[N, Kc] Xc;  // centered version of X without an intercept</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   vector[Kc] means_X;  // column means of X before centering</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   for (i in 2:K) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     means_X[i - 1] = mean(X[, i]);</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     Xc[, i - 1] = X[, i] - means_X[i - 1];</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> parameters {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   vector[Kc] b;  // regression coefficients</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   real Intercept;  // temporary intercept for centered predictors</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   real&lt;lower=0&gt; sigma;  // dispersion parameter</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> transformed parameters {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   real lprior = 0;  // prior contributions to the log posterior</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   lprior += normal_lpdf(Intercept | mean_intercept, 10);</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   lprior += student_t_lpdf(sigma | 3, 0, 4.4)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     - 1 * student_t_lccdf(0 | 3, 0, 4.4);</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> model {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   // likelihood including constants</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   if (!prior_only) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     target += normal_id_glm_lpdf(Y | Xc, Intercept, b, sigma);</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   // priors including constants</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   target += lprior;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> generated quantities {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   // actual population-level intercept</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   real b_Intercept = Intercept - dot_product(means_X, b);</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> }</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># define a multi-normal prior with known covariance matrix</span></span></span>
<span class="r-in"><span><span class="va">bprior</span> <span class="op">&lt;-</span> <span class="fu"><a href="set_prior.html">prior</a></span><span class="op">(</span><span class="fu">multi_normal</span><span class="op">(</span><span class="va">M</span>, <span class="va">V</span><span class="op">)</span>, class <span class="op">=</span> <span class="st">"b"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">stanvars</span> <span class="op">&lt;-</span> <span class="fu">stanvar</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2</span><span class="op">)</span>, <span class="st">"M"</span>, scode <span class="op">=</span> <span class="st">"  vector[K] M;"</span><span class="op">)</span> <span class="op">+</span></span></span>
<span class="r-in"><span>  <span class="fu">stanvar</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span>, <span class="st">"V"</span>, scode <span class="op">=</span> <span class="st">"  matrix[K, K] V;"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="stancode.html">stancode</a></span><span class="op">(</span><span class="va">count</span> <span class="op">~</span> <span class="va">Trt</span> <span class="op">+</span> <span class="va">zBase</span>, <span class="va">epilepsy</span>,</span></span>
<span class="r-in"><span>         prior <span class="op">=</span> <span class="va">bprior</span>, stanvars <span class="op">=</span> <span class="va">stanvars</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> // generated with brms 2.21.0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> functions {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> data {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   int&lt;lower=1&gt; N;  // total number of observations</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   vector[N] Y;  // response variable</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   int&lt;lower=1&gt; K;  // number of population-level effects</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   matrix[N, K] X;  // population-level design matrix</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   int&lt;lower=1&gt; Kc;  // number of population-level effects after centering</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   int prior_only;  // should the likelihood be ignored?</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     vector[K] M;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     matrix[K, K] V;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> transformed data {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   matrix[N, Kc] Xc;  // centered version of X without an intercept</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   vector[Kc] means_X;  // column means of X before centering</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   for (i in 2:K) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     means_X[i - 1] = mean(X[, i]);</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     Xc[, i - 1] = X[, i] - means_X[i - 1];</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> parameters {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   vector[Kc] b;  // regression coefficients</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   real Intercept;  // temporary intercept for centered predictors</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   real&lt;lower=0&gt; sigma;  // dispersion parameter</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> transformed parameters {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   real lprior = 0;  // prior contributions to the log posterior</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   lprior += multi_normal_lpdf(b | M, V);</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   lprior += student_t_lpdf(Intercept | 3, 4, 4.4);</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   lprior += student_t_lpdf(sigma | 3, 0, 4.4)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     - 1 * student_t_lccdf(0 | 3, 0, 4.4);</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> model {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   // likelihood including constants</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   if (!prior_only) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     target += normal_id_glm_lpdf(Y | Xc, Intercept, b, sigma);</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   // priors including constants</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   target += lprior;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> generated quantities {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   // actual population-level intercept</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   real b_Intercept = Intercept - dot_product(means_X, b);</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> }</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># define a hierachical prior on the regression coefficients</span></span></span>
<span class="r-in"><span><span class="va">bprior</span> <span class="op">&lt;-</span> <span class="fu"><a href="set_prior.html">set_prior</a></span><span class="op">(</span><span class="st">"normal(0, tau)"</span>, class <span class="op">=</span> <span class="st">"b"</span><span class="op">)</span> <span class="op">+</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="set_prior.html">set_prior</a></span><span class="op">(</span><span class="st">"target += normal_lpdf(tau | 0, 10)"</span>, check <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="va">stanvars</span> <span class="op">&lt;-</span> <span class="fu">stanvar</span><span class="op">(</span>scode <span class="op">=</span> <span class="st">"real&lt;lower=0&gt; tau;"</span>,</span></span>
<span class="r-in"><span>                    block <span class="op">=</span> <span class="st">"parameters"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="stancode.html">stancode</a></span><span class="op">(</span><span class="va">count</span> <span class="op">~</span> <span class="va">Trt</span> <span class="op">+</span> <span class="va">zBase</span>, <span class="va">epilepsy</span>,</span></span>
<span class="r-in"><span>         prior <span class="op">=</span> <span class="va">bprior</span>, stanvars <span class="op">=</span> <span class="va">stanvars</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> // generated with brms 2.21.0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> functions {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> data {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   int&lt;lower=1&gt; N;  // total number of observations</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   vector[N] Y;  // response variable</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   int&lt;lower=1&gt; K;  // number of population-level effects</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   matrix[N, K] X;  // population-level design matrix</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   int&lt;lower=1&gt; Kc;  // number of population-level effects after centering</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   int prior_only;  // should the likelihood be ignored?</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> transformed data {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   matrix[N, Kc] Xc;  // centered version of X without an intercept</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   vector[Kc] means_X;  // column means of X before centering</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   for (i in 2:K) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     means_X[i - 1] = mean(X[, i]);</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     Xc[, i - 1] = X[, i] - means_X[i - 1];</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> parameters {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   vector[Kc] b;  // regression coefficients</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   real Intercept;  // temporary intercept for centered predictors</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   real&lt;lower=0&gt; sigma;  // dispersion parameter</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   real&lt;lower=0&gt; tau;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> transformed parameters {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   real lprior = 0;  // prior contributions to the log posterior</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   lprior += normal_lpdf(b | 0, tau);</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   lprior += student_t_lpdf(Intercept | 3, 4, 4.4);</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   lprior += student_t_lpdf(sigma | 3, 0, 4.4)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     - 1 * student_t_lccdf(0 | 3, 0, 4.4);</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> model {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   // likelihood including constants</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   if (!prior_only) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     target += normal_id_glm_lpdf(Y | Xc, Intercept, b, sigma);</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   // priors including constants</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   target += lprior;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   target += normal_lpdf(tau | 0, 10);</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> generated quantities {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   // actual population-level intercept</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   real b_Intercept = Intercept - dot_product(means_X, b);</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> }</span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># ensure that 'tau' is passed to the likelihood of a threaded model</span></span></span>
<span class="r-in"><span><span class="co"># not necessary for this example but may be necessary in other cases</span></span></span>
<span class="r-in"><span><span class="va">stanvars</span> <span class="op">&lt;-</span> <span class="fu">stanvar</span><span class="op">(</span>scode <span class="op">=</span> <span class="st">"real&lt;lower=0&gt; tau;"</span>,</span></span>
<span class="r-in"><span>                    block <span class="op">=</span> <span class="st">"parameters"</span>, pll_args <span class="op">=</span> <span class="st">"real tau"</span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="fu"><a href="stancode.html">stancode</a></span><span class="op">(</span><span class="va">count</span> <span class="op">~</span> <span class="va">Trt</span> <span class="op">+</span> <span class="va">zBase</span>, <span class="va">epilepsy</span>,</span></span>
<span class="r-in"><span>         stanvars <span class="op">=</span> <span class="va">stanvars</span>, threads <span class="op">=</span> <span class="fu"><a href="threading.html">threading</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> // generated with brms 2.21.0</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> functions {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   /* integer sequence of values</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>    * Args:</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>    *   start: starting integer</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>    *   end: ending integer</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>    * Returns:</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>    *   an integer sequence from start to end</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>    */</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   array[] int sequence(int start, int end) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     array[end - start + 1] int seq;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     for (n in 1:num_elements(seq)) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>       seq[n] = n + start - 1;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     return seq;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   // compute partial sums of the log-likelihood</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   real partial_log_lik_lpmf(array[] int seq, int start, int end, data vector Y, data matrix Xc, vector b, real Intercept, real sigma, real tau) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     real ptarget = 0;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     int N = end - start + 1;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     ptarget += normal_id_glm_lpdf(Y[start:end] | Xc[start:end], Intercept, b, sigma);</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     return ptarget;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> data {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   int&lt;lower=1&gt; N;  // total number of observations</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   vector[N] Y;  // response variable</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   int&lt;lower=1&gt; K;  // number of population-level effects</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   matrix[N, K] X;  // population-level design matrix</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   int&lt;lower=1&gt; Kc;  // number of population-level effects after centering</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   int grainsize;  // grainsize for threading</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   int prior_only;  // should the likelihood be ignored?</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> transformed data {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   matrix[N, Kc] Xc;  // centered version of X without an intercept</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   vector[Kc] means_X;  // column means of X before centering</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   array[N] int seq = sequence(1, N);</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   for (i in 2:K) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     means_X[i - 1] = mean(X[, i]);</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     Xc[, i - 1] = X[, i] - means_X[i - 1];</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> parameters {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   vector[Kc] b;  // regression coefficients</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   real Intercept;  // temporary intercept for centered predictors</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   real&lt;lower=0&gt; sigma;  // dispersion parameter</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   real&lt;lower=0&gt; tau;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> transformed parameters {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   real lprior = 0;  // prior contributions to the log posterior</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   lprior += student_t_lpdf(Intercept | 3, 4, 4.4);</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   lprior += student_t_lpdf(sigma | 3, 0, 4.4)</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     - 1 * student_t_lccdf(0 | 3, 0, 4.4);</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> model {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   // likelihood including constants</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   if (!prior_only) {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>     target += reduce_sum(partial_log_lik_lpmf, seq, grainsize, Y, Xc, b, Intercept, sigma, tau);</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   // priors including constants</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   target += lprior;</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> }</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> generated quantities {</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   // actual population-level intercept</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   real b_Intercept = Intercept - dot_product(means_X, b);</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> }</span>
<span class="r-in"><span></span></span>
</code></pre></div>
    </div>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top"><h2 data-toc-skip>Contents</h2>
    </nav></div>
</div>


      <footer><div class="copyright">
  <p></p><p>Developed by Paul-Christian Bürkner.</p>
</div>

<div class="pkgdown">
  <p></p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer></div>

  


  

  </body></html>

